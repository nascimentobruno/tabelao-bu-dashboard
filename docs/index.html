<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Tabel√£o ‚Ä¢ BU</title>
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="login-overlay" aria-hidden="true">
    <div class="login-card">
      <div class="login-brand">
        <div class="login-mark">T</div>
        <div class="login-title">
          <div class="login-h1">Tabel√£o ‚Ä¢ BU</div>
          <div class="login-h2">Acesso restrito</div>
        </div>
      </div>

      <div class="login-form">
        <label class="login-label" for="pwd">Senha</label>
        <div class="login-input-row">
          <input id="pwd" class="login-input" type="password" placeholder="Digite a senha" autocomplete="current-password">
          <button id="btnTogglePwd" class="login-icon-btn" type="button" title="Mostrar/ocultar senha">üëÅÔ∏è</button>
        </div>

        <button id="btnLogin" class="login-btn" type="button">Entrar</button>
        <div id="loginMsg" class="login-msg"></div>

        <div class="login-hint">
          <span class="pill">Dica</span>
          Fale com o Administrador Respons√°vel.
        </div>
      </div>

      <div class="login-footer">
        <span>Vers√£o: GitHub Pages</span>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="layout" id="appRoot" style="visibility:hidden;">
    <aside class="sidebar" id="sidebar">
      <div class="brand">Tabel√£o ‚Ä¢ BU</div>

      <div class="month-filter">
        <label for="monthFilter">M√™s</label>
        <select id="monthFilter">
          <option value="ALL">Todos</option>
        </select>
      </div>

      <button class="nav-btn active" data-bu="imoveis" type="button">Im√≥veis</button>
      <button class="nav-btn" data-bu="carbuy" type="button">Carbuy</button>
      <button class="nav-btn" data-bu="veiculos" type="button">Ve√≠culos</button>

      <div class="sidebar-actions">
        <button id="btnLogout" class="ghost-btn" type="button">Sair</button>
      </div>

      <div class="updated" id="updatedBox"></div>
    </aside>

    <main class="content">
      <div class="topbar">
        <button id="btnToggleSidebar" class="menu-btn" type="button" title="Ocultar/mostrar menu">‚ò∞</button>
        <div>
          <div class="title">Dashboard por BU</div>
          <div class="subtitle" id="sourceSubtitle">Fonte: ‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="table-wrap">
          <table class="data-table">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

<script>
/* =========================
   CONFIG (F√ÅCIL DE TROCAR)
   ========================= */
const SENHA_PADRAO = "VIP666"; // <-- TROQUE AQUI QUANDO QUISER
const AUTH_KEY = "tabelao_auth_ok_v1";
const MANIFEST_URL = "data/manifest.json";
const PAGE_CHUNK_RENDER = 200;

/* =========================
   HELPERS
   ========================= */
async function sha256(text) {
  const enc = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}

function setMsg(el, text, kind="") {
  el.textContent = text;
  el.className = "login-msg" + (kind ? ` ${kind}` : "");
}

function showEmpty(msg) {
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  thead.innerHTML = "<tr><th>Status</th></tr>";
  tbody.innerHTML = `<tr><td>${msg}</td></tr>`;
}

async function fetchJson(url) {
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error(`HTTP ${res.status} ao buscar ${url}`);
  return await res.json();
}

/* =========================
   FORMATA√á√ÉO (FIX R$ ESTOQUE)
   ========================= */

// Colunas que devem ser tratadas como dinheiro (R$)
// Se tiver mais colunas de moeda, coloque aqui.
const MONEY_COLS = new Set([
  "R$ Estoque",
  "Faturamento"
]);

function toNumber(v) {
  if (v === null || v === undefined) return null;
  if (typeof v === "number") return Number.isFinite(v) ? v : null;

  if (typeof v === "string") {
    let s = v.trim();
    if (!s) return null;

    // remove s√≠mbolos e espa√ßos
    s = s.replace(/\s/g, "").replace("R$", "");

    // Se tiver v√≠rgula => formato pt-BR: 1.234,56
    // A√≠ sim removemos os pontos de milhar.
    if (s.includes(",")) {
      s = s.replace(/\./g, "").replace(",", ".");
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // Se N√ÉO tem v√≠rgula, o ponto √© decimal normal (ex.: 5182575.24)
    // N√ÉO pode remover.
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}

function formatCell(col, v) {
  if (v === null || v === undefined) return "";

  // dinheiro
  if (MONEY_COLS.has(col)) {
    const n = toNumber(v);
    if (n === null) return String(v);
    return n.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
  }

  // efici√™ncia: aceita 0.5333 (53,33%) ou 53.33 (j√° em %)
  if (col === "Efici√™ncia") {
    const n = toNumber(v);
    if (n === null) return String(v);
    const pct = (n >= 0 && n <= 1) ? n * 100 : n;
    return pct.toLocaleString("pt-BR", { maximumFractionDigits: 2 }) + "%";
  }

  // estoque (quantidade)
  if (col === "Estoque") {
    const n = toNumber(v);
    if (n === null) return String(v);
    return Math.round(n).toLocaleString("pt-BR");
  }

  // n√∫meros gerais
  if (typeof v === "number") return v.toLocaleString("pt-BR");
  return String(v);
}

/* =========================
   LOGIN (OFUSCADO)
   ========================= */
function isAuthed() {
  return localStorage.getItem(AUTH_KEY) === "1";
}

async function doLogin() {
  const pwd = document.getElementById("pwd").value || "";
  const msg = document.getElementById("loginMsg");

  if (!pwd.trim()) {
    setMsg(msg, "Digite a senha.", "err");
    return;
  }

  const [h1, h2] = await Promise.all([sha256(pwd), sha256(SENHA_PADRAO)]);
  if (h1 === h2) {
    localStorage.setItem(AUTH_KEY, "1");
    setMsg(msg, "OK! Entrando‚Ä¶", "ok");
    await bootApp();
  } else {
    setMsg(msg, "Senha incorreta.", "err");
  }
}

function doLogout() {
  localStorage.removeItem(AUTH_KEY);
  location.reload();
}

/* =========================
   APP (MANIFEST + PARTES)
   ========================= */
let manifestCache = null;
let currentBU = "imoveis";
let currentMonth = "ALL";

let loadedRows = [];
let partsForSelection = [];
let nextPartIndex = 0;
let renderLimit = PAGE_CHUNK_RENDER;

function resetState() {
  loadedRows = [];
  partsForSelection = [];
  nextPartIndex = 0;
  renderLimit = PAGE_CHUNK_RENDER;
}

function renderTable() {
  const thead = document.getElementById("thead");
  const tbody = document.getElementById("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  if (!loadedRows || loadedRows.length === 0) {
    showEmpty("Nenhuma linha carregada ainda.");
    return;
  }

  const first = loadedRows.find(r => r && typeof r === "object") || loadedRows[0];
  const cols = Object.keys(first).filter(c => c !== "__month");

  thead.innerHTML = "<tr>" + cols.map(c => `<th>${c}</th>`).join("") + "</tr>";

  const slice = loadedRows.slice(0, renderLimit);

  for (const row of slice) {
    const tr = document.createElement("tr");
    for (const c of cols) {
      const td = document.createElement("td");
      td.textContent = formatCell(c, row[c]); // <-- AQUI √â O FIX
      tr.appendChild(td);
    }
    tbody.appendChild(tr);
  }

  const trCtrl = document.createElement("tr");
  const tdCtrl = document.createElement("td");
  tdCtrl.colSpan = cols.length;

  const shown = slice.length;
  const totalLoaded = loadedRows.length;

  const hasMoreRender = shown < totalLoaded;
  const hasMoreDownload = nextPartIndex < partsForSelection.length;

  tdCtrl.innerHTML = `
    <div class="table-controls">
      <div class="table-controls__info">
        Mostrando <b>${shown}</b> de <b>${totalLoaded}</b> linhas baixadas
        ${hasMoreDownload ? "<span class='muted'>(mais dados dispon√≠veis para baixar)</span>" : "<span class='muted'>(tudo baixado)</span>"}
      </div>
      <div class="table-controls__actions">
        ${hasMoreRender ? `<button id="btnMoreRender" class="mini-btn" type="button">Mostrar +${PAGE_CHUNK_RENDER}</button>` : ""}
        ${hasMoreDownload ? `<button id="btnMoreDownload" class="mini-btn strong" type="button">Baixar pr√≥xima parte</button>` : ""}
      </div>
    </div>
  `;

  trCtrl.appendChild(tdCtrl);
  tbody.appendChild(trCtrl);

  const btnMoreRender = document.getElementById("btnMoreRender");
  if (btnMoreRender) btnMoreRender.onclick = () => { renderLimit += PAGE_CHUNK_RENDER; renderTable(); };

  const btnMoreDownload = document.getElementById("btnMoreDownload");
  if (btnMoreDownload) btnMoreDownload.onclick = async () => { await downloadNextPart(); };
}

async function downloadNextPart() {
  if (nextPartIndex >= partsForSelection.length) return;

  const part = partsForSelection[nextPartIndex];
  nextPartIndex += 1;

  showEmpty(`Baixando parte ${nextPartIndex}/${partsForSelection.length}‚Ä¶`);

  // part.file pode vir:
  // 1) "2026-01_part1.json" (sem pasta)
  // 2) "imoveis/2026-01_part1.json" (com pasta)
  // ent√£o aqui a gente NORMALIZA:
  let filePath = String(part.file || "").replace(/^\/+/, "");

  // se j√° come√ßar com "imoveis/" ou "carbuy/" ou "veiculos/", N√ÉO duplica
  const needsPrefix =
    !(filePath.startsWith("imoveis/") || filePath.startsWith("carbuy/") || filePath.startsWith("veiculos/"));

  const url = needsPrefix
    ? `data/${currentBU}/${filePath}`
    : `data/${filePath}`;

  console.log("FETCH:", url);

  const rows = await fetchJson(url);
  loadedRows = loadedRows.concat(rows);
  renderTable();
}

function resolveMonth(manifest) {
  if (currentMonth !== "ALL") return currentMonth;
  const months = (manifest.months || []);
  return months.length ? months[months.length - 1] : "";
}

async function loadSelection() {
  if (!manifestCache) return;

  resetState();
  const chosenMonth = resolveMonth(manifestCache);

  if (!chosenMonth) {
    showEmpty("Sem meses dispon√≠veis no manifest.");
    return;
  }

  const buMap = (manifestCache.files && manifestCache.files[currentBU]) ? manifestCache.files[currentBU] : {};
  const parts = buMap[chosenMonth] || [];

  if (!parts.length) {
    showEmpty(`Sem dados para ${currentBU} no m√™s ${chosenMonth}.`);
    return;
  }

  partsForSelection = parts;
  nextPartIndex = 0;

  await downloadNextPart();
}

function populateUIFromManifest(manifest) {
  const sel = document.getElementById("monthFilter");
  const keep = sel.value || "ALL";
  sel.innerHTML = "";

  const optAll = document.createElement("option");
  optAll.value = "ALL";
  optAll.textContent = "Todos";
  sel.appendChild(optAll);

  (manifest.months || []).forEach(m => {
    const o = document.createElement("option");
    o.value = m;
    o.textContent = (m.length === 7) ? `${m.slice(5)}/${m.slice(0,4)}` : m;
    sel.appendChild(o);
  });

  sel.value = keep;

  document.getElementById("sourceSubtitle").textContent = `Fonte: ${manifest.source || "‚Äî"}`;
  document.getElementById("updatedBox").innerHTML = `
    <div style="font-size:12px;opacity:.75;margin-bottom:8px;">
      Desenvolvido por Bruno Nascimento
    </div>
    Atualizado:<br>${manifest.generated_at || "‚Äî"}
  `;
}

function wireEvents() {
  document.querySelectorAll(".nav-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      document.querySelectorAll(".nav-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentBU = btn.dataset.bu;
      await loadSelection();
    });
  });

  const monthFilter = document.getElementById("monthFilter");
  monthFilter.addEventListener("change", async () => {
    currentMonth = monthFilter.value;
    await loadSelection();
  });

  document.getElementById("btnToggleSidebar").addEventListener("click", () => {
    document.body.classList.toggle("sidebar-collapsed");
  });

  document.getElementById("btnLogout").addEventListener("click", doLogout);

  document.getElementById("btnLogin").addEventListener("click", doLogin);
  document.getElementById("pwd").addEventListener("keydown", (e) => {
    if (e.key === "Enter") doLogin();
  });
  document.getElementById("btnTogglePwd").addEventListener("click", () => {
    const el = document.getElementById("pwd");
    el.type = (el.type === "password") ? "text" : "password";
  });
}

async function bootApp() {
  const overlay = document.getElementById("loginOverlay");
  overlay.style.display = "none";
  overlay.setAttribute("aria-hidden", "true");

  const appRoot = document.getElementById("appRoot");
  appRoot.style.visibility = "visible";

  showEmpty("Carregando manifest‚Ä¶");
  manifestCache = await fetchJson(MANIFEST_URL);
  populateUIFromManifest(manifestCache);

  const sel = document.getElementById("monthFilter");
  currentMonth = sel.value || "ALL";

  await loadSelection();
}

/* =========================
   START
   ========================= */
(async function start() {
  wireEvents();

  const overlay = document.getElementById("loginOverlay");
  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden", "false");

  if (isAuthed()) {
    await bootApp();
  } else {
    document.getElementById("appRoot").style.visibility = "hidden";
  }
})();
</script>

</body>
</html>
